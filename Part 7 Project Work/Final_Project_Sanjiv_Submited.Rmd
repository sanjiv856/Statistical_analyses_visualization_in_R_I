---
title: "Statistical analyses and visualization in R: I - HT21"
subtitle: "Final Project"
author: "Sanjiv Kumar"
date: "`r format(Sys.time(), '%d %B %Y')`" 
output:
  pdf_document: default
  word_document:
    fig_height: 7
    fig_width: 7
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(gt)
library(pracma) # for mode
library(ggpubr) # for ggarrange
library(memisc) # mtable 
library(multcomp) # for Tukey post-hoc test
library(Rmisc) # for summarySE
library(phia) # for testInteractions
library(effects) # for effect
library(knitr) # for kable
library(broom) # for tidy glht
library(jtools) # for summ
```
# Introduction   

We are analyzing the data set created by combining data from Gapminder (Ref. 1). The data was downloaded in the form of CSV files for the population, Human Development Index (HDI), Income per person (Income), Life Expectancy (LifeExp), The Sustainable Development Index (SDI), Region and Income Group of various countries. These parameters are defined as follows: 

**Population**: Data for the population was downloaded from Gapminder population data (Ref. 2). 

**Human Development Index (HDI)**: HDI is used to rank various countries by the level of human development and includes level of health, education and living standard (Ref. 3). 

**Income per person (Income)**: This is calculated as gross domestic product per person adjusted for inflation and is converted to dollars (from 2017) using power parity rates (Ref. 4). 

**Life Expectancy (LifeExp)**: It is the average number of years a newborn child would live, considering the current mortality patterns (Ref. 5).

**The Sustainable Development Index (SDI)**: This index assesses the ecological efficiency of nations in delivering human development considering “development index” and “ecological impact index” (Ref. 6). 

**GDP per capita (GDPPC)**: is calculated as GDP divided by midyear population, data is in constant of dollars (from 2010) (Ref. 7). 

**Metadata**: Income group and Region in the data were taken from the classification for The World Bank GNI (Ref. 8). 

Note: Rmarkdown for the report is attached at the end of the document as Appendix. 

## Data cleaning  

All data imported from CSV were read into R and cleaned (i.e., values in K, M, B etc. were converted to e3, e6, e9 respectively. The data is converted to tidy format using tidyverse (Ref. 9). Since, after combining all the data it became too large (>2.5 Gb) and therefore it was filtered only for few selected years (i.e., 1990, 1995, 2000, 2005, 2015, 2019). Missing data (i.e., `NA`) were removed. 
```{r message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE, out.width = "100%", fig.align="center"}
# Reading files

# Population
pop <- read.csv("data\\population_total.csv")
pop_tidy <- pop %>% 
  pivot_longer("X1800":"X2100", names_to = "year", values_to = "population")
pop_tidy$year <- sub("X", "", pop_tidy$year)
pop_tidy$population <- as.numeric(str_replace_all(pop_tidy$population, 
                                                  regex(c("M" = "e6", "K" = "e3", 
                                                          "B" = "e9"), 
                                                        ignore_case = TRUE)))
names(pop_tidy)[1] <- "country"
# Selected data from 1990 to 2019 with interval of ~5 years
pop_tidy_90_19 <- pop_tidy %>% 
  filter(year %in% c(1990, 1995, 2000, 2005, 2010, 2015, 2019))

head(pop_tidy)

# pop_tidy %>% 

pop_tidy %>% 
  filter(country == "Sweden") %>% 
  # head() %>% 
  ggplot(aes(year, population)) +
  geom_point()

# HDI
hdi <- read.csv("data\\hdi_human_development_index.csv")
hdi_noNA <- na.omit(hdi)
hdi_noNA_tidy <- hdi_noNA %>% 
  pivot_longer("X1990":"X2019", names_to = "year", values_to = "HDI")
hdi_noNA_tidy$year <- sub("X", "", hdi_noNA_tidy$year) 
names(hdi_noNA_tidy)[1] <- "country"
hdi_noNA_tidy_90_19 <- hdi_noNA_tidy %>% 
  filter(year %in% c(1990, 1995, 2000, 2005, 2010, 2015, 2019))

head(hdi_noNA_tidy)

hdi_noNA_tidy %>% 
  filter(country == "Sweden") %>% 
  # head() %>% 
  ggplot(aes(year, HDI)) +
  geom_point()

# Income 
income <- read.csv("data\\income_per_person_gdppercapita_ppp_inflation_adjusted.csv")
income_noNA <- na.omit(income)
income_noNA_tidy <- income_noNA %>%  
  pivot_longer("X1800" : "X2050", names_to = "year", values_to = "Income", 
               values_transform = list(Income = as.character))
income_noNA_tidy$year <- sub("X", "", income_noNA_tidy$year)
income_noNA_tidy$Income <- as.numeric(str_replace_all(income_noNA_tidy$Income, 
                                                      regex(c("M" = "e6", "K" = "e3", 
                                                              "B" = "e9"), 
                                                            ignore_case = TRUE)))
names(income_noNA_tidy)[1] <- "country"
income_noNA_tidy_90_19 <- income_noNA_tidy %>% 
  filter(year %in% c(1990, 1995, 2000, 2005, 2010, 2015, 2019))

income_noNA_tidy %>% 
  filter(country == "Sweden") %>% 
  # head()
  ggplot(aes(year, Income)) +
  geom_point()


# Life Expectancy 
lifeExp <- read.csv("data\\life_expectancy_years.csv")
lifeExp_noNA <- na.omit(lifeExp)
lifeExp_noNA_tidy <- lifeExp_noNA %>%  
  pivot_longer("X1800" : "X2100", names_to = "year", values_to = "LifeExp")
lifeExp_noNA_tidy$year <- sub("X", "", lifeExp_noNA_tidy$year)
names(lifeExp_noNA_tidy)[1] <- "country"
lifeExp_noNA_tidy_90_19 <- lifeExp_noNA_tidy %>% 
  filter(year %in% c(1990, 1995, 2000, 2005, 2010, 2015, 2019))

lifeExp_noNA_tidy %>% 
  filter(country == "Sweden") %>% 
  # head()
  ggplot(aes(year, LifeExp)) +
  geom_point()


# SDI
sdi <- read.csv("data\\sdi.csv")
sdi_noNA <- na.omit(sdi)
sdi_noNA_tidy <- sdi_noNA %>%  
  pivot_longer("X1990" : "X2019", names_to = "year", values_to = "SDI")
sdi_noNA_tidy$year <- sub("X", "", sdi_noNA_tidy$year)
names(sdi_noNA_tidy)[1] <- "country"
sdi_noNA_tidy_90_19 <- sdi_noNA_tidy %>% 
  filter(year %in% c(1990, 1995, 2000, 2005, 2010, 2015, 2019))

sdi_noNA_tidy %>% 
  filter(country == "Sweden") %>% 
  # head()
  ggplot(aes(year, SDI)) +
  geom_point()

# GDP per capita
gdppc <- read.csv("data\\gdppercapita_us_inflation_adjusted.csv", 
                  na.strings=c(NA,"NA"," NA"))
gdppc_noNA <- na.omit(gdppc)
gdppc_noNA_tidy <- gdppc_noNA %>%  
  pivot_longer("X1960" : "X2020", names_to = "year", values_to = "GDPPC")
gdppc_noNA_tidy$year <- sub("X", "", gdppc_noNA_tidy$year)
gdppc_noNA_tidy$GDPPC <- as.numeric(str_replace_all(gdppc_noNA_tidy$GDPPC, 
                                                    regex(c("M" = "e6", "K" = "e3", 
                                                            "B" = "e9"), 
                                                          ignore_case = TRUE)))
gdppc_noNA_tidy_90_19 <- gdppc_noNA_tidy %>% 
  filter(year %in% c(1990, 1995, 2000, 2005, 2010, 2015, 2019))
names(gdppc_noNA_tidy_90_19)[1] <- "country"
gdppc_noNA_tidy_90_19 <- na.omit(gdppc_noNA_tidy_90_19)

gdppc_noNA_tidy %>% 
  filter(country == "Sweden") %>% 
  # head()
  ggplot(aes(year, GDPPC)) +
  geom_point()

# Metadata
metadata <-  read.csv("data\\Metadata_Country_API_NY.GNP.MKTP.PP.CD_DS2_en_csv_v2_3479540.csv")
metadata_fewCols <- metadata[c(5, 2, 3)]
metadata_fewCols_noNA <- na.omit(metadata_fewCols)
names(metadata_fewCols_noNA)[1] <- "country"

# Combining all data
adding_data <- list(pop_tidy_90_19, hdi_noNA_tidy_90_19, income_noNA_tidy_90_19, 
                    lifeExp_noNA_tidy_90_19, sdi_noNA_tidy_90_19, 
                    gdppc_noNA_tidy_90_19) %>% 
    reduce(left_join, by = c("country", "year"))
all_datatidy_90_19 <- list(adding_data, metadata_fewCols_noNA) %>% 
  reduce(left_join, by = "country")
names(all_datatidy_90_19) <- c("Country", "Year", "Population", "HDI", 
                               "Income (USD)", "LifeExp (Years)", "SDI", 
                               "GDPPC (USD)", "Region", "IncomeGroup")
# which(is.na(all_datatidy_90_19_noNA))
all_datatidy_90_19_noNA <- na.omit(all_datatidy_90_19)

all_datatidy_90_19_noNA$Region <- as.factor(all_datatidy_90_19_noNA$Region)
all_datatidy_90_19_noNA$IncomeGroup <- as.factor(all_datatidy_90_19_noNA$IncomeGroup)

```

## Examining measures of cental tendency across various parameters

Measures of central tendency (i.e., Mean, Median, Mode, SD, StdErr, and Var) were calculated (Table 1). 
```{r message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE}

# Measures of central tendency (Mean, Median, Mode, SD, StdErr, and Var)

# Population 
data_table_pop <- all_datatidy_90_19_noNA %>% 
  group_by(Region) %>% 
  summarise("Mean" = mean(Population), 
            "Median" = median(Population), 
            "Mode" = Mode(Population),
            "SD" = sd(Population), 
            "StdErr" = sd(Population)/sqrt(length(Population)), 
            "Var" = var(Population)) %>% 
  # mutate_if(is.numeric, ~round(., 3)) %>% 
  gt() %>% 
  tab_header(title = paste("Table 1: Distribution of population across various regions",
                           sep = "\n"), subtitle = "(From 1990 to 2019)")
```
```{r message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE}
# HDI 
data_table_hdi <- all_datatidy_90_19_noNA %>% 
  group_by(Region) %>% 
  summarise("Mean" = mean(HDI), 
            "Median" = median(HDI), 
            "Mode" = Mode(HDI),
            "SD" = sd(HDI), 
            "StdErr" = sd(HDI)/sqrt(length(HDI)), 
            "Var" = var(HDI)) %>% 
  mutate_if(is.numeric, ~round(., 3)) %>% 
  gt() %>% 
  tab_header(title = paste("Table 2: Distribution of Human Development Index (HDI) across various regions",
                           sep = "\n"), subtitle = "(From 1990 to 2019)")
```
```{r message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE}
# Income 
data_table_Income <- all_datatidy_90_19_noNA %>% 
  group_by(Region) %>% 
  summarise("Mean" = mean(`Income (USD)`), 
            "Median" = median(`Income (USD)`), 
            "Mode" = Mode(`Income (USD)`),
            "SD" = sd(`Income (USD)`), 
            "StdErr" = sd(`Income (USD)`)/sqrt(length(`Income (USD)`)), 
            "Var" = var(`Income (USD)`)) %>% 
  mutate_if(is.numeric, ~round(., 3)) %>% 
  gt() %>% 
  tab_header(title = paste("Table 3: Distribution of Income (USD) across various regions",
                           sep = "\n"), subtitle = "(From 1990 to 2019)")
```
```{r message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE}
# Life Expectancy 
data_table_LifeExp <- all_datatidy_90_19_noNA %>% 
  group_by(Region) %>% 
  summarise("Mean" = mean(`LifeExp (Years)`), 
            "Median" = median(`LifeExp (Years)`), 
            "Mode" = Mode(`LifeExp (Years)`),
            "SD" = sd(`LifeExp (Years)`), 
            "StdErr" = sd(`LifeExp (Years)`)/sqrt(length(`LifeExp (Years)`)), 
            "Var" = var(`LifeExp (Years)`)) %>% 
  mutate_if(is.numeric, ~round(., 3)) %>% 
  gt() %>% 
  tab_header(title = paste("Table 4: Distribution of Life Expectancy (Years) across various regions",
                           sep = "\n"), subtitle = "(From 1990 to 2019)")
```
```{r message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE}
# SDI 
data_table_sdi <- all_datatidy_90_19_noNA %>% 
  group_by(Region) %>% 
  summarise("Mean" = mean(SDI), 
            "Median" = median(SDI), 
            "Mode" = Mode(SDI),
            "SD" = sd(SDI), 
            "StdErr" = sd(SDI)/sqrt(length(SDI)), 
            "Var" = var(SDI)) %>% 
  mutate_if(is.numeric, ~round(., 3)) %>% 
  gt() %>% 
  tab_header(title = paste("Table 5: Distribution of The Sustainable Development Index (SDI) across various regions",
                           sep = "\n"), subtitle = "(From 1990 to 2019)")
```
```{r message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE}
# GDP per capita 
data_table_gdppc <- all_datatidy_90_19_noNA %>% 
  group_by(Region) %>% 
  summarise("Mean" = mean(`GDPPC (USD)`), 
            "Median" = median(`GDPPC (USD)`), 
            "Mode" = Mode(`GDPPC (USD)`),
            "SD" = sd(`GDPPC (USD)`), 
            "StdErr" = sd(`GDPPC (USD)`)/sqrt(length(`GDPPC (USD)`)), 
            "Var" = var(`GDPPC (USD)`)) %>% 
  mutate_if(is.numeric, ~round(., 3)) %>% 
  gt() %>% 
  tab_header(title = paste("Table 6: Distribution of GDP per capita (USD) across various regions",
                           sep = "\n"), subtitle = "(From 1990 to 2019)")
```
```{r message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE}
centraltendencyTable = gt(rbind(data_table_pop$`_data`, data_table_hdi$`_data`, 
                                data_table_Income$`_data`, data_table_LifeExp$`_data`,
                                data_table_sdi$`_data`, data_table_gdppc$`_data`)) %>%
  tab_row_group(label = "Population", rows = 1) %>% 
  tab_row_group(label = "HDI", rows = 2) %>% 
  tab_row_group(label = "Income", rows = 3) %>% 
  tab_row_group(label = "LifeExp", rows = 4) %>% 
  tab_row_group(label = "SDI", rows = 5) %>% 
  tab_row_group(label = "GDPPC", rows = 6) %>% 
  row_group_order(groups = c("Population", "HDI", "Income", "LifeExp", "SDI", "GDPPC")) %>% 
  tab_header(title = "Table 1: Measures of central tendency across various parameters",
             subtitle = "(From 1990 to 2019)")
centraltendencyTable
```

## Data visualization (Histogram) across various parameters

Histograms were generated to examine the distribution of data (Figure 1). 
```{r message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE, out.width = "80%", fig.align="center"}

all_hist_Pop <- all_datatidy_90_19_noNA %>%
  group_by(Country) %>% 
  ggplot(., aes(Population)) +
  geom_histogram(bins = 30) +
  labs(title="Population across countries", x="Population", y="Frequency") +
  theme(axis.line = element_line(size = 0.7, color = "black"),
        text = element_text(size = 12),
        plot.title = element_text(size= 12),
        axis.text.x = element_text(angle = 45, hjust = 1))

all_hist_hdi <- all_datatidy_90_19_noNA %>% 
  group_by(Country) %>% 
  ggplot(., aes(HDI)) +
  geom_histogram(bins = 30)  +
  labs(title="HDI across countries", x="HDI", y="Frequency") +
  theme(axis.line = element_line(size = 0.7, color = "black"),
        text = element_text(size = 12),
        plot.title = element_text(size= 12),
        axis.text.x = element_text(angle = 45, hjust = 1))

all_hist_Income <- all_datatidy_90_19_noNA %>% 
  group_by(Country) %>% 
  ggplot(., aes(`Income (USD)`)) +
  geom_histogram(bins = 30) +
  labs(title="Income (USD) across countries", x="Income (USD)", y="Frequency") +
  theme(axis.line = element_line(size = 0.7, color = "black"),
        text = element_text(size = 12),
        plot.title = element_text(size= 12),
        axis.text.x = element_text(angle = 45, hjust = 1))

all_hist_sdi <- all_datatidy_90_19_noNA %>% 
  group_by(Country) %>% 
  ggplot(., aes(SDI)) +
  geom_histogram(bins = 30) +
  labs(title="SDI across countries", x="SDI", y="Frequency") +
  theme(axis.line = element_line(size = 0.7, color = "black"),
        text = element_text(size = 12),
        plot.title = element_text(size= 12),
        axis.text.x = element_text(angle = 45, hjust = 1))

all_hist_GDPPC <- all_datatidy_90_19_noNA %>% 
  group_by(Country) %>% 
  ggplot(., aes(`GDPPC (USD)`)) +
  geom_histogram(bins = 30) +
  labs(title="GDPPC (USD) across countries", x="GDP Per Capita (USD)", y="Frequency") +
  theme(axis.line = element_line(size = 0.7, color = "black"),
        text = element_text(size = 12),
        plot.title = element_text(size= 12),
        axis.text.x = element_text(angle = 45, hjust = 1))

all_hist_Region <- all_datatidy_90_19_noNA %>% 
  group_by(Country) %>% 
  ggplot(., aes(Region)) +
  geom_histogram(stat = "count") +
  labs(title="Countries across region", x="Region", y="Frequency") +
  theme(axis.line = element_line(size = 0.7, color = "black"),
        text = element_text(size = 12),
        plot.title = element_text(size= 12),
        axis.text.x = element_text(angle = 45, hjust = 1))

all_hist_IncomeGroup <- all_datatidy_90_19_noNA %>% 
  group_by(Country) %>% 
  ggplot(., aes(IncomeGroup)) +
  geom_histogram(stat = "count") +
  labs(title="Countries across Income groups", x="Income Group", y="Frequency") +
  theme(axis.line = element_line(size = 0.7, color = "black"),
        text = element_text(size = 12),
        plot.title = element_text(size= 12),
        axis.text.x = element_text(angle = 45, hjust = 1))

ggarrange(all_hist_Pop, all_hist_hdi, nrow = 1, ncol = 2, 
          labels = c("A", "B")) 

ggarrange(all_hist_Income, all_hist_sdi, nrow = 1, ncol = 2, 
          labels = c("C", "D")) 

ggarrange(all_hist_GDPPC, all_hist_Region, nrow = 1, ncol = 2, 
          labels = c("E", "F")) 

ggarrange(all_hist_IncomeGroup, nrow = 1, ncol = 1, 
          labels = c("G")) %>% 
          annotate_figure(bottom = text_grob("Figure 1: Distribution of data across various parameters",
                                             size = 16))
```
## Questions 

### --------------------------------------------------------------------------------------------------------------------------
### 1. At least one of the questions must be a trend analysis, e.g. using correlation or linear regression.
### --------------------------------------------------------------------------------------------------------------------------

#### Has HDI increased globally from 1990 to 2019?
```{r message=FALSE, warning=FALSE, include=FALSE}
Reg.Model_HDI_Global_normal <- lm(HDI ~ as.integer(Year), data=all_datatidy_90_19_noNA)
summary(Reg.Model_HDI_Global_normal)
```
The Q-Q plot, the residuals appear to be on straight line, and Residuals vs Fitted graphs shows spread in the largest group is not more than three times the spread in the smallest group, therefore, data was not transformed. Regression model was generated for HDI over Years from 1990 to 2019. From the figure (Figure 2 A) it is evident that there is a liner increase in HDI from 1990 to 2019 globally. Statistics Report:  
```{r message=FALSE, warning=FALSE, include=FALSE}
par(mfrow = c(2, 2))
plot(Reg.Model_HDI_Global_normal)
par(mfrow = c(1, 1))
```
```{r message=FALSE, warning=FALSE, include=FALSE}
Reg.Model_HDI_Global_normal_ggplot <- ggplot(all_datatidy_90_19_noNA, 
                                             aes(as.integer(Year), HDI)) +
  geom_point() +
  geom_smooth(method = "lm", colour="blue") +
  labs(title="Increase in HDI globally", x="Year", y="HDI") +
  scale_y_continuous(breaks = seq(0, 1, 0.1)) +
  scale_x_continuous(breaks = seq(0, 2050, 5), limits = c(1989, 2020)) +
  theme(panel.grid.major = element_line(size = 0.5, color = "grey"),
        panel.grid.minor = element_line(size = 0.5, color = "grey"),
        plot.title = element_text(hjust = 0.5, size = 12),
        axis.line = element_line(size = 0.7, color = "black"),
        text = element_text(size = 12), 
        axis.text = element_text(angle=0, vjust=0.5, size=12, face = "bold"), 
        axis.text.x = element_text(angle = 45, hjust = 1), 
        panel.background = element_rect(fill = "grey85",
                                        size = 0.5, linetype = "solid"), 
        axis.ticks = element_line(size = 0.5, colour = "black"))

Reg.Model_HDI_Global_normal_ggplot
```
* r-squared: `r summary(Reg.Model_HDI_Global_normal)$adj.r.squared`
* b (regression coefficient): `r Reg.Model_HDI_Global_normal$coefficients[1]`
* SEb: `r summary(Reg.Model_HDI_Global_normal)$coefficients[2, 2]`
* t: `r summary(Reg.Model_HDI_Global_normal)$coefficients[2, 3]`
* df: `r summary(Reg.Model_HDI_Global_normal)$df`
* p: `r summary(Reg.Model_HDI_Global_normal)$coefficients[2, 4]`

#### Has Income increased world-wide from 1990 to 2019?
```{r message=FALSE, warning=FALSE, include=FALSE}
Reg.Model_income_Global_normal <- lm(`Income (USD)` ~ as.integer(Year), 
                                     data=all_datatidy_90_19_noNA)
summary(Reg.Model_income_Global_normal)
```
The Q-Q plot, the residuals appear to be on straight line, and Residuals vs Fitted graphs shows spread in the largest group is not more than three times the spread in the smallest group, therefore, data was not transformed. Regression model was generated for Income over Years from 1990 to 2019. From the figure (Figure 2 B) it is evident that there is a liner increase in Income from 1990 to 2019 globally. Statistics Report:
```{r message=FALSE, warning=FALSE, echo=FALSE, include=FALSE}
par(mfrow = c(2, 2))
plot(Reg.Model_income_Global_normal)
par(mfrow = c(1, 1))
```
```{r message=FALSE, warning=FALSE, include=FALSE}
Reg.Model_income_Global_normal_ggplot <- ggplot(all_datatidy_90_19_noNA, 
                                                aes(as.integer(Year), 
                                                    log10(`Income (USD)`))) +
  geom_point() +
  geom_smooth(method = "lm", colour="blue") +
  labs(title="Increase in Income globally", x="Year", 
       y="Income (USD) (log10 scale)") +
  scale_y_continuous(breaks = seq(0, 100, 0.5)) +
  scale_x_continuous(breaks = seq(0, 2050, 5), limits = c(1989, 2020)) +
  theme(panel.grid.major = element_line(size = 0.5, color = "grey"),
        panel.grid.minor = element_line(size = 0.5, color = "grey"),
        plot.title = element_text(hjust = 0.5, size = 12),
        axis.line = element_line(size = 0.7, color = "black"),
        text = element_text(size = 12), 
        axis.text = element_text(angle=0, vjust=0.5, size=12, face = "bold"), 
        axis.text.x = element_text(angle = 45, hjust = 1), 
        panel.background = element_rect(fill = "grey85",
                                        size = 0.5, linetype = "solid"), 
        axis.ticks = element_line(size = 0.5, colour = "black"))

Reg.Model_income_Global_normal_ggplot
```
* r-squared: `r summary(Reg.Model_income_Global_normal)$adj.r.squared`
* b (regression coefficient): `r Reg.Model_income_Global_normal$coefficients[1]`
* SEb: `r summary(Reg.Model_income_Global_normal)$coefficients[2, 2]`
* t: `r summary(Reg.Model_income_Global_normal)$coefficients[2, 3]`
* df: `r summary(Reg.Model_income_Global_normal)$df`
* p: `r summary(Reg.Model_income_Global_normal)$coefficients[2, 4]`

#### Has LifeExp increased globaly from 1990 to 2019?
```{r message=FALSE, warning=FALSE, include=FALSE}
Reg.Model_LifeExp_Global_normal <- lm(`LifeExp (Years)` ~ as.integer(Year), data=all_datatidy_90_19_noNA)
summary(Reg.Model_LifeExp_Global_normal)
```
The Q-Q plot, the residuals appear to be on straight line, and Residuals vs Fitted graphs shows spread in the largest group is not more than three times the spread in the smallest group, therefore, data was not transformed. Regression model was generated for LifeExp over Years from 1990 to 2019. From the figure (Figure 2 C) it is evident that there is a liner increase in LifeExp from 1990 to 2019 globally. Statistics Report: 
```{r message=FALSE, warning=FALSE, include=FALSE}
par(mfrow = c(2, 2))
plot(Reg.Model_LifeExp_Global_normal)
par(mfrow = c(1, 1))
```
```{r message=FALSE, warning=FALSE, include=FALSE}
Reg.Model_LifeExp_Global_normal_ggplot <- ggplot(all_datatidy_90_19_noNA, aes(as.integer(Year), `LifeExp (Years)`)) +
  geom_point() +
  geom_smooth(method = "lm", colour="blue") +
  labs(title="Increase in LifeExp globally", x="Year", y="LifeExp (Years)") +
  scale_y_continuous(breaks = seq(0, 100, 5)) +
  scale_x_continuous(breaks = seq(0, 2050, 5), limits = c(1989, 2020)) +
  theme(panel.grid.major = element_line(size = 0.5, color = "grey"),
        panel.grid.minor = element_line(size = 0.5, color = "grey"),
        plot.title = element_text(hjust = 0.5, size = 12),
        axis.line = element_line(size = 0.7, color = "black"),
        text = element_text(size = 12), 
        axis.text = element_text(angle=0, vjust=0.5, size=12, face = "bold"), 
        axis.text.x = element_text(angle = 45, hjust = 1), 
        panel.background = element_rect(fill = "grey85",
                                        size = 0.5, linetype = "solid"), 
        axis.ticks = element_line(size = 0.5, colour = "black"))

Reg.Model_LifeExp_Global_normal_ggplot
```
* r-squared: `r summary(Reg.Model_LifeExp_Global_normal)$adj.r.squared`
* b (regression coefficient): `r Reg.Model_LifeExp_Global_normal$coefficients[1]`
* SEb: `r summary(Reg.Model_LifeExp_Global_normal)$coefficients[2, 2]`
* t: `r summary(Reg.Model_LifeExp_Global_normal)$coefficients[2, 3]`
* df: `r summary(Reg.Model_LifeExp_Global_normal)$df`
* p: `r summary(Reg.Model_LifeExp_Global_normal)$coefficients[2, 4]`

### Has GDPPC increased from 1990 to 2019?
```{r message=FALSE, warning=FALSE, include=FALSE}
Reg.Model_gdppc_Global_normal <- lm(`GDPPC (USD)` ~ as.integer(Year), 
                                     data=all_datatidy_90_19_noNA)
summary(Reg.Model_gdppc_Global_normal)
```
The Q-Q plot, the residuals appear to be on straight line, and Residuals vs Fitted graphs shows spread in the largest group is not more than three times the spread in the smallest group, therefore, data was not transformed. Regression model was generated for GDPPC over Years from 1990 to 2019. From the figure (Figure 2 D) it is evident that there is a liner increase in GDPPC from 1990 to 2019 globally. Statistics Report:
```{r message=FALSE, warning=FALSE, include=FALSE}
par(mfrow = c(2, 2))
plot(Reg.Model_gdppc_Global_normal)
par(mfrow = c(1, 1))
```
```{r message=FALSE, warning=FALSE, include=FALSE}
Reg.Model_gdppc_Global_normal_ggplot <- ggplot(all_datatidy_90_19_noNA, 
                                                aes(as.integer(Year), 
                                                    `GDPPC (USD)`)) +
  geom_point() +
  geom_smooth(method = "lm", colour="blue") +
  labs(title="Increase in GDPPC (USD) globally", x="Year", 
       y="GDPPC (USD)") +
  scale_y_continuous(breaks = seq(0, 1000000, 10000)) +
  scale_x_continuous(breaks = seq(0, 2050, 5), limits = c(1989, 2020)) +
  theme(panel.grid.major = element_line(size = 0.5, color = "grey"),
        panel.grid.minor = element_line(size = 0.5, color = "grey"),
        plot.title = element_text(hjust = 0.5, size = 12),
        axis.line = element_line(size = 0.7, color = "black"),
        text = element_text(size = 12), 
        axis.text = element_text(angle=0, vjust=0.5, size=12, face = "bold"), 
        axis.text.x = element_text(angle = 45, hjust = 1), 
        panel.background = element_rect(fill = "grey85",
                                        size = 0.5, linetype = "solid"), 
        axis.ticks = element_line(size = 0.5, colour = "black"))

Reg.Model_gdppc_Global_normal_ggplot
```
* r-squared: `r summary(Reg.Model_gdppc_Global_normal)$adj.r.squared`
* b (regression coefficient): `r Reg.Model_gdppc_Global_normal$coefficients[1]`
* SEb: `r summary(Reg.Model_gdppc_Global_normal)$coefficients[2, 2]`
* t: `r summary(Reg.Model_gdppc_Global_normal)$coefficients[2, 3]`
* df: `r summary(Reg.Model_gdppc_Global_normal)$df`
* p: `r summary(Reg.Model_gdppc_Global_normal)$coefficients[2, 4]`
```{r message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE, out.width = "70%", fig.align="center"}
ggarrange(Reg.Model_HDI_Global_normal_ggplot, Reg.Model_income_Global_normal_ggplot,
          nrow = 1, ncol = 2, labels = c("A", "B")) 
ggarrange(Reg.Model_LifeExp_Global_normal_ggplot, Reg.Model_gdppc_Global_normal_ggplot, 
          nrow = 1, ncol = 2, labels = c("C", "D")) %>% 
          annotate_figure(bottom = text_grob("Figure 2: Linear Regression analysis", 
                                             size = 14))
```
### --------------------------------------------------------------------------------------------------------------------------
### 2. At least one of the questions must deal with differences between two groups, e.g. using t-test or non-parametric alternatives
### --------------------------------------------------------------------------------------------------------------------------

### Non-parametric test: Wilcoxon’s rank-sum test

#### Is there's a difference in the Life expectancy between Low Income and High Income group (IncomeGroup)?

The life expectancy data is not normally distributed data, it is left skewed (Figure 3A) and therefore, non-parametric test Wilcoxon’s rank-sum test would be used in this case. This is also supported by shapiro.test, with p-value < 2.2e-16.
```{r message=FALSE, warning=FALSE, include=FALSE}
shapiro.test(subset(all_datatidy_90_19_noNA, 
                    IncomeGroup %in% c("Low income", 
                                       "High income"))$`LifeExp (Years)`)
```
```{r message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE, out.width = "70%", fig.align="center"}
income_group_hist <- ggplot(subset(all_datatidy_90_19_noNA, 
                                   IncomeGroup %in% c("Low income", "High income")), 
                            aes(`LifeExp (Years)`)) +
  geom_histogram(bins = 10) +
  labs(title="Life expectancy among low and high income countries", 
       x="LifeExp (Years)", y="Count") +
    # scale_y_continuous(breaks = seq(0, 200, 30, limits = c(0, 200))) +
  # scale_x_continuous(breaks = seq(0, 100, 10), limits = c(30, 100)) +
  theme(panel.grid.major = element_line(size = 0.5, color = "grey"),
        panel.grid.minor = element_line(size = 0.5, color = "grey"),
        plot.title = element_text(hjust = 0.5, size = 7),
        axis.line = element_line(size = 0.7, color = "black"),
        text = element_text(size = 12), 
        axis.text = element_text(angle=0, vjust=0.5, size=12, face = "bold"), 
        axis.text.x = element_text(angle = 45, hjust = 1), 
        panel.background = element_rect(fill = "grey85",
                                        size = 0.5, linetype = "solid"), 
        axis.ticks = element_line(size = 0.5, colour = "black"), 
        plot.caption = element_text(hjust = 0.5, size = 12))
```
#### Wilcoxon rank-sum test
```{r message=FALSE, warning=FALSE, include=FALSE}
wilcox_LifeExp_IncomeGroup <- wilcox.test(subset(all_datatidy_90_19_noNA, 
                                                 IncomeGroup %in% c("Low income", 
                                                                    "High income"))$`LifeExp (Years)` ~
                                            subset(all_datatidy_90_19_noNA, 
                                                   IncomeGroup %in% c("Low income", 
                                                                      "High income"))$IncomeGroup)
```
Since, the p-value `r wilcox_LifeExp_IncomeGroup$p.value` is less then than the significance level 0.05, it is therefore concluded that there is significant difference between the life expectancy between the two group i.e. low and high income. W = 24724.

## Distribution by Income Group

Graph (Figure 3B) representing the difference between low and high income countries. The boxplot plot shows that the life expectancy of high income group is higher than low income group. 
```{r message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE, out.width = "70%", fig.align="center"}
income_group_boxplot <- ggplot(subset(all_datatidy_90_19_noNA, 
                                     IncomeGroup %in% c("Low income", "High income"))) +
  aes(x = IncomeGroup, y = `LifeExp (Years)`) +
  geom_boxplot(fill = "grey") +
  labs(title="Boxplot of difference between low and high income countries", 
       x="Income Group", 
       y="LifeExp (Years)") +
   theme(panel.grid.major = element_line(size = 0.5, color = "grey"),
        panel.grid.minor = element_line(size = 0.5, color = "grey"),
        plot.title = element_text(hjust = 0.5, size = 7),
        axis.line = element_line(size = 0.7, color = "black"),
        text = element_text(size = 12), 
        axis.text = element_text(angle=0, vjust=0.5, size=12, face = "bold"), 
        axis.text.x = element_text(angle = 45, hjust = 1), 
        panel.background = element_rect(fill = "grey85",
                                        size = 0.5, linetype = "solid"), 
        axis.ticks = element_line(size = 0.5, colour = "black"), 
        plot.caption = element_text(hjust = 0.5, size = 12))
```
```{r message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE, out.width = "100%", fig.align="center"}
ggarrange(income_group_hist, income_group_boxplot, 
          nrow = 1, ncol = 2, labels = c("A", "B")) %>% 
          annotate_figure(bottom = text_grob("Figure 3: Histogram and boxplot of difference between low and high income countries", 
                                             size = 12))
```
### --------------------------------------------------------------------------------------------------------------------------
### 3. At least one of the questions must deal with differences between more than two groups, e.g. using different versions of ANOVAs or non-parametric alternatives.
### --------------------------------------------------------------------------------------------------------------------------

#### Is there is a effect of `Region` and `IncomeGroup` on life expectancy?

Since we are examining the effect of two different categorical independent variable (`Regions` and `IncomeGroup`) and one continuous dependent variable (`LifeExp (Years)`) (Table 2), two-way ANOVA was performed. The data was visvualized using boxplot (Figure 4). 
```{r message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE, out.width = "80%", fig.align="center"}
all_datatidy_90_19_noNA %>%
  group_by(Region, IncomeGroup) %>%
  get_summary_stats(`LifeExp (Years)`, type = "mean_sd") %>% 
  gt() %>% 
    tab_header(title = "Table 2: Effect of Region and IncomeGroup on Life Expectancy",
    subtitle = "Measured central tendencies")
```
```{r message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE, out.width = "100%", fig.align="center"}
## Plot of means 
region_lifeExp_boxplot <- ggplot(all_datatidy_90_19_noNA, aes(x = Region , y = `LifeExp (Years)`)) +
   geom_boxplot() +
   labs(title="Effect of Region on Life Expectancy",
        x ="Regions", y = "LifeExp (Years)") +
    theme(panel.grid.major = element_line(size = 0.5, color = "grey"),
        panel.grid.minor = element_line(size = 0.5, color = "grey"),
        plot.title = element_text(hjust = 0.5, size = 8),
        axis.line = element_line(size = 0.7, color = "black"),
        text = element_text(size = 8), 
        axis.text = element_text(angle=0, vjust=0.5, size=7, face = "bold"), 
        axis.text.x = element_text(angle = 45, hjust = 1), 
        panel.background = element_rect(fill = "grey85",
                                        size = 0.5, linetype = "solid"), 
        axis.ticks = element_line(size = 0.5, colour = "black"), 
        plot.caption = element_text(hjust = 0.5, size = 8))

income_lifeExp_boxplot <- ggplot(all_datatidy_90_19_noNA, aes(x = IncomeGroup , y = `LifeExp (Years)`)) +
   geom_boxplot() +
   labs(title="Effect of IncomeGroup on Life Expectancy",
        x ="Regions", y = "LifeExp (Years)") +
    theme(panel.grid.major = element_line(size = 0.5, color = "grey"),
        panel.grid.minor = element_line(size = 0.5, color = "grey"),
        plot.title = element_text(hjust = 0.5, size = 8),
        axis.line = element_line(size = 0.7, color = "black"),
        text = element_text(size = 8), 
        axis.text = element_text(angle=0, vjust=0.5, size=7, face = "bold"), 
        axis.text.x = element_text(angle = 45, hjust = 1), 
        panel.background = element_rect(fill = "grey85",
                                        size = 0.5, linetype = "solid"), 
        axis.ticks = element_line(size = 0.5, colour = "black"), 
        plot.caption = element_text(hjust = 0.5, size = 8))

ggarrange(region_lifeExp_boxplot, income_lifeExp_boxplot, 
          nrow = 1, ncol = 2, labels = c("A", "B")) %>% 
          annotate_figure(bottom = text_grob("Figure 4: Effect of Region and IncomeGroup on Life Expectancy", 
                                             size = 12))
```
In `Q-Q plot` looks good but the difference of the spread in largest group is more than three times the spread in the group with the smallest spread as appears from `Residuals vs Fitted`. Therefore, the data was log transformed. 
```{r message=FALSE, warning=FALSE, include=FALSE}
lm_lifeExp <- lm(`LifeExp (Years)` ~ Region * IncomeGroup, 
                 all_datatidy_90_19_noNA, na.action=na.omit)
summary(lm_lifeExp)

par(mfrow = c(2, 2))
plot(lm_lifeExp)
par(mfrow = c(1, 1))
```
```{r message=FALSE, warning=FALSE, include=FALSE}
lm_lifeExp_log10 <- lm(log10(`LifeExp (Years)`) ~ Region + IncomeGroup, 
                       data = all_datatidy_90_19_noNA, na.action=na.omit)
summary(lm_lifeExp_log10)

par(mfrow = c(2, 2))
plot(lm_lifeExp_log10)
par(mfrow = c(1, 1))
```

Anova Table: 
```{r message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE, out.width = "80%", fig.align="center"}
Anova(lm_lifeExp_log10)
```

Both `Region` and `IncomeGroup` has significant effect on life expectancy. 

Statistics Report:

* Test: Two-way ANOVA
* F-value: `r anova(lm_lifeExp_log10)$'F value'[1]`
* df: `r anova(lm_lifeExp_log10)$Df[2]`
* p-value: `r anova(lm_lifeExp_log10)$'Pr(>F)'[1]`

Pair-wise comparison using Tukey post-hoc test using `glht` from `multcomp`. The table below show the significant differences among the groups.

Tukey post-hoc test:
```{r message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE, out.width = "100%", fig.align="center"}
R1 <- glht(lm_lifeExp_log10, mcp(Region = "Tukey"))$linfct
R2 <- glht(lm_lifeExp_log10, mcp(IncomeGroup = "Tukey"))$linfct

glht_sum <- summary(glht(lm_lifeExp_log10, linfct = rbind(R1, R2)))

glht_sum
```
The differences among the income groups is significant. On the contrary, the difference among the regions is only significant for few cases. Plot of means (Figure 5).
```{r message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE, out.width = "100%", fig.align="center"}
sum_Region <- summarySE(all_datatidy_90_19_noNA, measurevar= "LifeExp (Years)", 
                        groupvars="Region") 
sum_Region_ggplot <- ggplot(sum_Region, aes(x= Region, y= `LifeExp (Years)`)) + 
  geom_errorbar(aes(ymin= `LifeExp (Years)` - se, ymax=`LifeExp (Years)` + se), 
                width=.1) + 
  geom_point() +
   labs(title="Effect of Region on Life Expectancy",
        x ="Regions", y = "LifeExp (Years)") +
    theme(panel.grid.major = element_line(size = 0.5, color = "grey"),
        panel.grid.minor = element_line(size = 0.5, color = "grey"),
        plot.title = element_text(hjust = 0.5),
        axis.line = element_line(size = 0.7, color = "black"),
        text = element_text(size = 8), 
        axis.text = element_text(angle=0, vjust=0.5, size=7, face = "bold"), 
        axis.text.x = element_text(angle = 45, hjust = 1), 
        panel.background = element_rect(fill = "grey85",
                                        size = 0.5, linetype = "solid"), 
        axis.ticks = element_line(size = 0.5, colour = "black"))

sum_IncomeGroup <- summarySE(all_datatidy_90_19_noNA, measurevar= "LifeExp (Years)", 
                        groupvars= "IncomeGroup") #summarySE

sum_IncomeGroup_ggplot <- ggplot(sum_IncomeGroup, aes(x= IncomeGroup, y= `LifeExp (Years)`)) + 
  geom_errorbar(aes(ymin= `LifeExp (Years)` - se, ymax=`LifeExp (Years)` + se), 
                width=.1) + 
  geom_point() +
   labs(title="Effect of IncomeGroup on Life Expectancy",
        x ="Income Group", y = "LifeExp (Years)") +
    theme(panel.grid.major = element_line(size = 0.5, color = "grey"),
        panel.grid.minor = element_line(size = 0.5, color = "grey"),
        plot.title = element_text(hjust = 0.5),
        axis.line = element_line(size = 0.7, color = "black"),
        text = element_text(size = 8), 
        axis.text = element_text(angle=0, vjust=0.5, size=7, face = "bold"), 
        axis.text.x = element_text(angle = 45, hjust = 1), 
        panel.background = element_rect(fill = "grey85",
                                        size = 0.5, linetype = "solid"), 
        axis.ticks = element_line(size = 0.5, colour = "black"))

ggarrange(sum_Region_ggplot, sum_IncomeGroup_ggplot, 
          nrow = 1, ncol = 2, labels = c("A", "B")) %>% 
          annotate_figure(bottom = text_grob("Figure 5: Plot of means, effect of Region and IncomeGroup on Life Expectancy", 
                                             size = 12))
```

Post-hoc test to evaluate pairwise differences among the different `Regions` with holms-correction.
```{r message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE, out.width = "100%", fig.align="center"}
testInteractions(lm_lifeExp_log10, pairwise = "Region", adjustment="holm")
```

Post-hoc test to evaluate pairwise differences among the different `IncomeGroup` with holms-correction.
```{r message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE, out.width = "100%", fig.align="center"}
testInteractions(lm_lifeExp_log10, pairwise = "IncomeGroup", adjustment="holm")
```

Effect plot of effect of Region and IncomeGroup on Life Expectancy (Figure 6). 
```{r message=FALSE, warning=FALSE, echo=FALSE, eval=TRUE, out.width = "80%", fig.align="center"}
plot(effect(term = "Region:IncomeGroup", mod = lm_lifeExp_log10, se=TRUE, 
            x.var= "IncomeGroup"),
     ylab="LifeExp (Years)", 
     xlab= "IncomeGroup", 
     main="Fig. 6: Effect plot of Region and IncomeGroup on Life Expectancy",
     colors = c(3,4))
```

### --------------------------------------------------------------------------------------------------------------------------
### 4. At least one of the questions must deal with count data, e.g using chi-square tests.
### --------------------------------------------------------------------------------------------------------------------------

### If there is an association between distribution of countries by `Region` and `IncomeGroup`? 

Following is the distribution of the `Regions` as per the `IncomeGroup` (Table 3).
```{r, message=FALSE, warning=FALSE, echo=FALSE, include=TRUE}

country_by_region <- all_datatidy_90_19_noNA[, 9:10]

as_tibble(table(country_by_region)) %>% 
  gt() %>% 
    tab_header(title = "Table 3: Region and IncomeGroup",
    subtitle = "")
```

#### Contingency Table 
From the data provided a contingency table was prepared with the sums at the margins (Table 4). The table shows that the smallest count is less then 5 (i.e., 0), Fisher's exact test was used for further analysis. 
```{r, message=FALSE, warning=FALSE, echo=FALSE, include=TRUE}
addmargins(table(country_by_region)) %>% 
  kable(caption = "Table 4: Contingency Table")
```

#### Fisher’s exact test

Since the smallest count (expected frequencies) are less then 5, i.e. 0 (see Table 4), Fisher’s exact test was performed instead of Chi-square test ($\chi ^{2}$). Here, since the values were too small, `workspace` was increased, but that also gave error with a suggestion to use 'simulate.p.value=TRUE', which was incorporated. `B` value, corresponding to number of replicates used in Monte Carlo was increased to 200000.  
```{r, message=FALSE, warning=FALSE, echo=FALSE, include=TRUE}
country_by_region_table = table(country_by_region)
country_by_region_table_fi = fisher.test(country_by_region_table, 
                                         simulate.p.value=TRUE, 
                                         B = 200000)
country_by_region_table_fi
```

Statistics Report:

* Type of test: `r country_by_region_table_fi$method`
* p-value: `r country_by_region_table_fi$p.value`

#### Data visualization 

Data was visualized using ggplot (Figure 7).
```{r, message=FALSE, warning=FALSE, echo=FALSE, include=TRUE, fig.align = 'center', out.width = "100%"}
ggplot(country_by_region, aes(x=Region, fill = IncomeGroup)) +
  geom_bar(position = "dodge") +
  labs(caption="Figure 7: Distribution of regions as per the IncomeGroup type", 
       x="Region", y="Frequencies") +
  theme(panel.grid.major = element_line(size = 0.5, color = "grey"),
        legend.position = c(0.85, 0.75),
        # legend.title = element_text(colour="black", size=12, face="bold"),
        legend.title = element_blank(),
        legend.text = element_text(colour="black", size=8, face="bold"),
        panel.grid.minor = element_line(size = 0.5, color = "grey"),
        plot.title = element_text(hjust = 0.5),
        axis.line = element_line(size = 0.7, color = "black"),
        text = element_text(size = 12),
        axis.text = element_text(angle=0, vjust=0.5, size=8, face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        panel.background = element_rect(fill = "grey85",
                                        size = 0.5, linetype = "solid"),
        axis.ticks = element_line(size = 0.5, colour = "black"), 
        plot.caption = element_text(hjust = 0.5, size = 12))
```

Fisher’s exact test with p-value (`r country_by_region_table_fi$p.value`) hence p<0.05, therefore, we reject the H0 (null hypothesis) and we conclude that there is significant association between the distribution of the regions as per their income groups. 

# References

1.	Gapminder: https://www.gapminder.org/data\\
2.	Population: http://gapm.io/dpop
3.	HDI: https://hdr.undp.org/en
4.	Income: http://gapm.io/dgdppc
5.	LifeExp: http://gapm.io/ilex
6.	SDI: http://gapm.io/dsdi
7.	GDPPC: https://data.worldbank.org/indicator/NY.GDP.PCAP.KD
8.	Metadata: https://data.worldbank.org/indicator/NY.GNP.MKTP.PP.CD
9.	Wickham H, Averick M, Bryan J, Chang W, McGowan LD, François R, Grolemund G, Hayes A, Henry L, Hester J, Kuhn M. Welcome to the Tidyverse. Journal of open source software. 2019 Nov 21;4(43):1686.

### Appendix 
```{r, ref.label=knitr::all_labels(),echo=TRUE,eval=FALSE}
```
